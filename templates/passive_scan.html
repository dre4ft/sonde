<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Sonde d'audit réseau - IHM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    pre.payload-preview {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      margin: 0;
    }
  </style>
</head>
<body>

<div class="container my-4">
  <h1 class="mb-4">Sonde d'audit réseau</h1>

  <div class="row mb-3 align-items-center">
    <label for="iface" class="col-sm-2 col-form-label">Interface réseau :</label>
    <div class="col-sm-4">
      <input type="text" id="iface" class="form-control" placeholder="ex: eth0" value="" />
    </div>
    <div class="col-sm-6 d-flex gap-2">
      <button class="btn btn-success" onclick="startCapture()">Démarrer la capture</button>
      <button class="btn btn-danger" onclick="stopCapture()">Arrêter la capture</button>
    </div>
  </div>

  <p id="status" class="fw-bold">Statut : <span class="text-muted">Inactif</span></p>

  <h2 class="mt-5 mb-3">Paquets capturés (derniers 100)</h2>
  <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
    <table id="packets-table" class="table table-striped table-bordered table-hover align-middle">
      <thead class="table-secondary sticky-top">
        <tr>
          <th>ID</th>
          <th>Timestamp</th>
          <th>Src IP</th>
          <th>Dst IP</th>
          <th>Proto</th>
          <th>Src Port</th>
          <th>Dst Port</th>
          <th>Payload</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Modal Bootstrap pour afficher le payload complet -->
<div class="modal fade" id="payloadModal" tabindex="-1" aria-labelledby="payloadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="payloadModalLabel">Contenu du paquet</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <pre id="modalPayload" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
async function startCapture() {
  const iface = document.getElementById("iface").value.trim();
  if (!iface) {
    alert("Veuillez saisir une interface réseau.");
    return;
  }
  try {
    const resp = await fetch("/api/start_capture", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({interface: iface})
    });
    if (resp.ok) {
      document.getElementById("status").innerHTML = 'Statut : <span class="text-success">Capture démarrée sur ' + iface + '</span>';
    } else {
      const err = await resp.json();
      document.getElementById("status").innerHTML = 'Erreur : <span class="text-danger">' + err.detail + '</span>';
    }
  } catch (e) {
    document.getElementById("status").innerHTML = '<span class="text-danger">Erreur de connexion</span>';
  }
}

async function stopCapture() {
  try {
    const resp = await fetch("/api/stop_capture", {method: "POST"});
    if (resp.ok) {
      document.getElementById("status").innerHTML = 'Statut : <span class="text-warning">Capture arrêtée</span>';
    } else {
      const err = await resp.json();
      document.getElementById("status").innerHTML = 'Erreur : <span class="text-danger">' + err.detail + '</span>';
    }
  } catch (e) {
    document.getElementById("status").innerHTML = '<span class="text-danger">Erreur de connexion</span>';
  }
}

function showPayloadModal(payload) {
  const modalPayload = document.getElementById('modalPayload');
  modalPayload.textContent = payload;
  const modal = new bootstrap.Modal(document.getElementById('payloadModal'));
  modal.show();
}

async function fetchPackets() {
  try {
    const resp = await fetch("/api/packets/");
    if (!resp.ok) throw new Error("HTTP " + resp.status);
    const packets = await resp.json();
    const tbody = document.querySelector("#packets-table tbody");
    tbody.innerHTML = "";

    for (const p of packets) {
      const bgColor = p.rule_matched ? "#b1fac5" : "#ff6e6";

      // 1ère ligne avec infos classiques + coloration
      const tr1 = document.createElement("tr");

      // Appliquer la couleur de fond à chaque cellule
      tr1.innerHTML = `
        <td style="background-color: ${bgColor};">${p.id}</td>
        <td style="background-color: ${bgColor};">${p.timestamp}</td>
        <td style="background-color: ${bgColor};">${p.src_ip}</td>
        <td style="background-color: ${bgColor};">${p.dst_ip}</td>
        <td style="background-color: ${bgColor};">${p.protocol}</td>
        <td style="background-color: ${bgColor};">${p.src_port ?? ""}</td>
        <td style="background-color: ${bgColor};">${p.dst_port ?? ""}</td>
        <td style="background-color: ${bgColor};">
          <pre class="payload-preview">${p.raw.length > 50 ? p.raw.slice(0, 50) + '...' : p.raw}</pre>
          ${p.raw.length > 50 ? `<button class="btn btn-sm btn-link p-0" onclick="showPayloadModal(\`${p.raw.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`)">Voir plus</button>` : ''}
        </td>
      `;

      tbody.appendChild(tr1);
    }
  } catch (e) {
    console.error("Erreur fetchPackets:", e);
  }
}

setInterval(fetchPackets, 1000);
fetchPackets();
</script>

</body>
</html>
